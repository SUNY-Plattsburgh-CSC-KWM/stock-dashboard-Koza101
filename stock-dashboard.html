<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard</title>
    
    <!-- React and Babel libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- D3.js for sparklines & .LESS styling language -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/less@4"></script>
    
    <style lang="less">
    @primary-color: #2c3e50;
    @secondary-color: #2980b9;
    @success-color: #27ae60;
    @hover-color: #f8f9fa;
    @border-color: #ddd;
    
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
    }
    
    h1 {
        color: #333;
        text-align: center;
    }
    
    table {
        width: 100%;
        max-width: 1000px;
        margin: 20px auto;
        border-collapse: collapse;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        
        th {
            background-color: @primary-color;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid @border-color;
            
            &:nth-child(3), &:nth-child(4) {
                font-weight: bold;
                color: @success-color;
            }
            
            &:first-child {
                font-weight: bold;
                color: @secondary-color;
            }
        }
        
        tr:hover {
            background-color: @hover-color;
        }
    }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        function Sparkline({ data, width = 150, height = 50 }) {
    const svgRef = React.useRef();
    
    React.useEffect(() => {
        if (!data || data.length === 0) return;
        
        d3.select(svgRef.current).selectAll("*").remove();
        
        const svg = d3.select(svgRef.current);
        const margin = { top: 5, right: 5, bottom: 5, left: 5 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;
        
        const xScale = d3.scaleLinear()
            .domain([0, data.length - 1])
            .range([0, innerWidth]);
            
        const yScale = d3.scaleLinear()
            .domain([d3.min(data), d3.max(data)])
            .range([innerHeight, 0]);
        
        const line = d3.line()
            .x((d, i) => xScale(i))
            .y(d => yScale(d))
            .curve(d3.curveMonotoneX);
        
        svg.append("path")
            .datum(data)
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 1.5)
            .attr("d", line)
            .attr("transform", `translate(${margin.left},${margin.top})`);
            
    }, [data, width, height]);
    
    return <svg ref={svgRef} width={width} height={height}></svg>;
    }

        function formatPrice(price) {
    return '$' + price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatVolume(volume) {
    return volume.toLocaleString();
    }

        function StockDashboard() {
        
    const [stocks, setStocks] = React.useState({
        IBM: { ticker: 'IBM', name: 'International Business Machines', price: 0, volume: 0, priceHistory: [] },
        AMZN: { ticker: 'AMZN', name: 'Amazon', price: 0, volume: 0, priceHistory: [] },
        DOW: { ticker: 'DOW', name: 'Dow Jones Industrial Average', price: 0, volume: 0, priceHistory: [] },
        NASDAQ: { ticker: 'NASDAQ', name: 'Nasdaq Composite', price: 0, volume: 0, priceHistory: [] }
    });

    React.useEffect(() => {
    
    const eventSource = new EventSource('http://127.0.0.1:31415/stocks');
    
    eventSource.onmessage = (event) => {
        const stockData = JSON.parse(event.data);
        console.log('Received:', stockData);
        
        
        setStocks(prevStocks => {
            const updatedStock = { ...prevStocks[stockData.ticker] };
            updatedStock.price = stockData.price;
            updatedStock.volume = stockData.volume;
            
            
            updatedStock.priceHistory = [...updatedStock.priceHistory, stockData.price];
            if (updatedStock.priceHistory.length > 500) {
                updatedStock.priceHistory.shift();
            }
            
            return {
                ...prevStocks,
                [stockData.ticker]: updatedStock
            };
        });
    };
    
    
    return () => {
        eventSource.close();
    };
}, []);

    return (
        <div>
            <h1>Stock Dashboard</h1>
            <table border="1">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Volume</th>
                        <th>Sparkline</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{stocks.IBM.ticker}</td>
                        <td>{stocks.IBM.name}</td>
                        <td>{formatPrice(stocks.IBM.price)}</td>
                        <td>{formatVolume(stocks.IBM.volume)}</td>
                        <td><Sparkline data={stocks.IBM.priceHistory} /></td>
                    </tr>
                    <tr>
                        <td>{stocks.AMZN.ticker}</td>
                        <td>{stocks.AMZN.name}</td>
                        <td>{formatPrice(stocks.AMZN.price)}</td>
                        <td>{formatVolume(stocks.AMZN.volume)}</td>
                        <td><Sparkline data={stocks.AMZN.priceHistory} /></td>
                    </tr>
                    <tr>
                        <td>{stocks.DOW.ticker}</td>
                        <td>{stocks.DOW.name}</td>
                        <td>{formatPrice(stocks.DOW.price)}</td>
                        <td>{formatVolume(stocks.DOW.volume)}</td>
                        <td><Sparkline data={stocks.DOW.priceHistory} /></td>
                    </tr>
                    <tr>
                        <td>{stocks.NASDAQ.ticker}</td>
                        <td>{stocks.NASDAQ.name}</td>
                        <td>{formatPrice(stocks.NASDAQ.price)}</td>
                        <td>{formatVolume(stocks.NASDAQ.volume)}</td>
                        <td><Sparkline data={stocks.NASDAQ.priceHistory} /></td>
                    </tr>
                </tbody>
            </table>
        </div>
    );
}

ReactDOM.render(<StockDashboard />, document.getElementById('root'));
    </script>
</body>
</html>